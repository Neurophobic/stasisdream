<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>STASIS/DREAM</title>
  <meta name="description" content="The HTML5 Herald">
  <meta name="author" content="SitePoint">

  <link rel="stylesheet" href="client/css/style.css">

  <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
  <![endif]-->
</head>

<body>

	<div id="signDiv">
		Username:<input id="signDiv-username" type="text"></input>
		</br>
		Password:<input id="signDiv-password" type="password"></input>
		<button id="signDiv-signIn">Sign in</button>
		<button id="signDiv-signUp">Sign up</button>
	</div>

	<div id="gameDiv" style="display:none;">
		<canvas id="ctx" > </canvas>


		<div id="chat-text" style ="width:500px; height:100px; overflow-y:scroll">
		</div>

		<form id="chat-form">
			<input id="chat-input" type="text" style="width:500px"></input>
		</form>
	</div>



	<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
	<script>

		var socket = io();

		//sign
		var signDiv = document.getElementById('signDiv');
		var signDivUsername = document.getElementById('signDiv-username');
		var signDivPassword = document.getElementById('signDiv-password');
		var signDivSignUp = document.getElementById('signDiv-signUp');
		var signDivSignIn = document.getElementById('signDiv-signIn');

		//signin
		signDivSignIn.onclick = function(){
			socket.emit('signIn', {username:signDivUsername.value, 
									password:signDivPassword.value});
		}
		socket.on('signInResponse', function(data){
			if(data.success){
				signDiv.style.display = 'none';
				gameDiv.style.display = 'inline-block';
			} else {
				alert("sign in unsuccessful");
			}
		})

		//signup
		signDivSignUp.onclick = function(){
			socket.emit('signUp', {username:signDivUsername.value, 
									password:signDivPassword.value});
		}
		socket.on('signUpResponse', function(data){
			if(data.success){
				alert("sign up successful")
			} else {
				alert("sign up unsuccessful");
			}
		})


		//game
		var chatText = document.getElementById('chat-text');
		var chatInput = document.getElementById('chat-input');
		var chatForm =  document.getElementById('chat-form');

		var canvas = document.getElementById('ctx');
		var ctx = document.getElementById("ctx").getContext("2d");

		canvas.width = window.innerWidth;
		canvas.height = window.innerHeight;

		// load image
		var image = new Image();  
		image.src = 'client/img/thing2.png'; 

		var Img = {};
		Img.player = new Image();
		Img.player.src = '/client/img/runningForward.png';
		Img.player1 = new Image();
		Img.player1.src = '/client/img/player.png';


		Img.map = {};
		Img.map['field'] = new Image();
		Img.map['field'].src = '/client/img/field.jpg';

		Img.map['forest'] = new Image();
		Img.map['forest'].src = '/client/img/forest.jpg';

		Img.black = new Image();
		Img.black.src = 'client/img/black.png';
		Img.green = new Image();
		Img.green.src = 'client/img/floorTile1.png';
		Img.wallTop = new Image();
		Img.wallTop.src = 'client/img/wallTop.png';

 

		ctx.font = "15px Arial";

		var Player = function(initPack){
			var self = {};
			self.id = initPack.id;
			self.number = initPack.number;
			self.x = initPack.x;
			self.y = initPack.y;
			self.hp = initPack.hp;
			self.maxHp = initPack.maxHp;
			self.score = initPack.score;
			self.isMoving = false;
			self.mouseAngle= 100;
			self.map = initPack.map;


			var frameCount = 0;

			self.draw = function(){

				if(Player.list[selfId].map !== self.map){
					return;
				}
				frameCount++;
				var walkMod = frameCount % 10;
				// console.log(self.isMoving);
				var hpWidth = 200 * self.hp / self.hpMax;
				var height =  128;
				var width = 48;


				var x = self.x - Player.list[selfId].x +canvas.width/2;
				var y = self.y - Player.list[selfId].y + canvas.height/2;

				var aimAngle = self.mouseAngle;

				if(aimAngle < 0){
					aimAngle = 360 + aimAngle;
				}
				var directionMod =2; //facing right
				if(aimAngle >= 45 && aimAngle <135){
					//down
					directionMod = 1;
				} else if(aimAngle >= 135 && aimAngle <225){
					//left
					directionMod = 3;
				} else if(aimAngle >225 && aimAngle <315){
					//up
					directionMod = 0;
				}

				if(self.isMoving){
					ctx.drawImage(Img.player, walkMod*width, 0, width, height,x-width/2,y-height/2, width,height);
				} else {
					ctx.drawImage(Img.player1, directionMod*width, 0, width, height,x-width/2,y-height/2, width,height);
				}
				
				ctx.fillRect(self.x , self.y - 40, hpWidth, 4);
				// ctx.fillText(self.score, self.x, self.y-20);
				ctx.fillText(self.hp, x, y-0);
			};

			Player.list[self.id] = self;
			return self;
		}
		Player.list = {};

		var Bullet = function(initPack){
			var self = {};
			self.id = initPack.id;
			self.x = initPack.x;
			self.y = initPack.y;
			self.map = initPack.map;

			self.draw = function(){
				if(Player.list[selfId].map !== self.map){
					return;
				}
				var x = self.x - Player.list[selfId].x +canvas.width/2;
				var y = self.y - Player.list[selfId].y + canvas.height/2;
				ctx.fillRect(x,y,4,4);
			};
			Bullet.list[self.id] = self;
			return self;
		}

		Bullet.list = {};


		//who is the client?
		var selfId = null;


		socket.on('init', function(data){
			if(data.selfId){
				selfId = data.selfId;
			};
			for(var i=0; i < data.player.length; i++){
				new Player(data.player[i]);
			};
			for(var i=0; i < data.bullet.length; i++){
				new Bullet(data.bullet[i]);
			};
		});

		socket.on('update', function(data){
			for(var i=0; i<data.player.length; i++){
				var pack = data.player[i];
				var p = Player.list[pack.id];
				if(p){
					if(pack.x !== undefined){
						p.x = pack.x;
					}
					if(pack.y !== undefined){
						p.y = pack.y;
					}
					if(pack.hp !== undefined){
						p.hp = pack.hp;
					}
					if(pack.score !== undefined){
						p.score = pack.score;
					}
					if(pack.isMoving !== undefined){
						p.isMoving = pack.isMoving;
					}
					if(pack.mouseAngle !== undefined){
						p.mouseAngle = pack.mouseAngle;
					}
				}
			}

			for(var i=0; i<data.bullet.length; i++){
				var pack = data.bullet[i];
				var b = Bullet.list[data.bullet[i].id];
				if(b){
					if(pack.x !== undefined){
						b.x = pack.x;
					}
					if(pack.y !== undefined){
						b.y = pack.y;
					}
				}
			}
		});

		socket.on('remove', function(data){
			for(var i = 0; i<data.player.length; i++){
				delete Player.list[data.player[i]];
			}

			for(var i = 0; i<data.bullet.length; i++){
				delete Bullet.list[data.bullet[i]];
			}
		});


		setInterval(function(){
			if(!selfId){
				return;
			};
			ctx.clearRect(0,0,canvas.width,canvas.height);

			drawMap();
			drawScore();

			for(var i in Player.list){
				Player.list[i].draw();
			};

			for(var i in Bullet.list){
				
				Bullet.list[i].draw();
			};
		}, 40);

		var mapArray = [
			[2,2,2,2,2,0,0,2,2,2,2],
			[1,0,0,0,0,0,0,2,0,0,0],
			[1,0,0,0,0,0,0,0,0,0,0],
			[1,1,1,0,1,1,1,0,0,0,1],
		];

		var drawMap = function(){
			var x = canvas.width/2 - Player.list[selfId].x;
			var y = canvas.height/2 - Player.list[selfId].y;

			if(Player.list[selfId].map === 'forest'){

			var modX = 0;
			var modY = 0;

				for(var r=0; r < mapArray.length; r++){
					//row
					for(var c=0; c < mapArray[r].length; c++){
						//column
						if(mapArray[r][c] == 0){
							ctx.drawImage(Img.green, x+modX, y+modY);
						}else if(mapArray[r][c] == 1){
							ctx.drawImage(Img.black, x+modX, y+modY);
						}else if(mapArray[r][c] ==2){
							ctx.drawImage(Img.wallTop, x+modX, (y+modY)-(Img.wallTop.height/2));
						}
						modX+=64;
					}
					modX = 0;
					modY+= 64;
				};
				// ctx.drawImage(Img.map['forest'], x,y);

			}else if(Player.list[selfId].map === 'field'){
				ctx.drawImage(Img.map['field'], x,y);

			} else if(Player.list[selfId].map === 'field'){
				ctx.drawImage(Img.map['field'], x,y);

			}  
			
		};

		var drawScore = function(){
			ctx.fillText(Player.list[selfId].score,0,30);
		}
	


		socket.on('addToChat', function(data){
			chatText.innerHTML += '<div>' +data+ '</div>';
		});

		socket.on('evalAnswer', function(data){
			chatText.innerHTML += '<div>' +data+ '</div>';
			console.log(data);
		});

		chatForm.onsubmit = function(e){
			e.preventDefault();
			if(chatInput.value[0] === '/'){
				socket.emit('evalServer',chatInput.value.slice(1));
			} else {
				socket.emit('sendMsgToServer',chatInput.value);
			}
			
			chatInput.value = "";
		}

		document.onkeydown = function(event){
			if(event.keyCode === 68){
				//D
				socket.emit('keyPress', {inputId:"right", state:true});
			} else if(event.keyCode === 83){
				//S
				socket.emit('keyPress', {inputId:"down", state:true});
			} else if(event.keyCode === 65){
				//A
				socket.emit('keyPress', {inputId:"left", state:true});
			} else if(event.keyCode === 87){
				//W
				socket.emit('keyPress', {inputId:"up", state:true});
			} 
		}

		document.onkeyup = function(event){
			if(event.keyCode === 68){
				//D
				socket.emit('keyPress', {inputId:"right", state:false});
			} else if(event.keyCode === 83){
				//S
				socket.emit('keyPress', {inputId:"down", state:false});
			} else if(event.keyCode === 65){
				//A
				socket.emit('keyPress', {inputId:"left", state:false});
			} else if(event.keyCode === 87){
				//W
				socket.emit('keyPress', {inputId:"up", state:false});
			}
		}


		document.onmousedown = function(event){
			socket.emit('keyPress', {inputId:'attack', state:true});
		}

		document.onmouseup = function(event){
			socket.emit('keyPress', {inputId:'attack', state:false});
			console.log("attack press");
		}

		document.onmousemove = function(event){
			var x = -(canvas.width/2) +event.clientX - 8;
			var y = -(canvas.height/2) +event.clientY - 8;

			var angle = Math.atan2(y,x)/Math.PI *180;
			socket.emit('keyPress', {inputId:'mouseAngle', state:angle});
			// console.log(angle);
		}
	</script>


	</body>
</html>